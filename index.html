<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PROPART V42 | REAL CONNECT</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700;900&family=Roboto+Mono&display=swap" rel="stylesheet">
    <style>
        :root { --blue: #00f3ff; --purple: #bc13fe; --dark: #050505; --green: #0f0; --red: #ff0055; --gold: #ffcc00; }
        * { box-sizing: border-box; }
        body { background: var(--dark); color: white; font-family: 'Roboto Mono', monospace; margin: 0; padding-bottom: 100px; }
        .top-bar { background: #000; padding: 15px; border-bottom: 2px solid var(--blue); text-align: center; box-shadow: 0 0 15px var(--blue); position: sticky; top: 0; z-index: 1001; }
        .screen { display: none; padding: 15px; }
        .screen.active { display: block; }
        .card { background: #111; border: 1px solid #222; border-left: 4px solid var(--blue); padding: 15px; margin-bottom: 15px; border-radius: 8px; }
        .btn { background: var(--blue); color: #000; border: none; padding: 15px; width: 100%; font-family: 'Orbitron'; font-weight: bold; margin-top: 10px; border-radius: 8px; cursor: pointer; font-size: 0.7rem; text-transform: uppercase; }
        .live-data { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        .data-box { background: #000; border: 1px solid #333; padding: 10px; border-radius: 5px; text-align: center; }
        .val { display: block; color: var(--green); font-size: 1.2rem; font-family: 'Orbitron'; }
        .lbl { font-size: 0.6rem; color: #888; }
        .nav { position: fixed; bottom: 0; width: 100%; background: #000; border-top: 2px solid var(--purple); display: flex; justify-content: space-around; padding: 12px 0; z-index: 1000; }
        .nav-item { color: #444; font-size: 0.55rem; text-align: center; flex: 1; font-family: 'Orbitron'; cursor: pointer; }
        .nav-item.active { color: var(--blue); text-shadow: 0 0 10px var(--blue); }
    </style>
</head>
<body>

    <div class="top-bar">
        <div id="status" style="font-family:'Orbitron'; color:var(--red); font-size: 0.7rem;">ESTADO: NO VINCULADO</div>
    </div>

    <div id="diag" class="screen active">
        <button class="btn" onclick="conectarOBD()" style="background:var(--green); margin-bottom:15px;">üîó VINCULAR REAL ELM327</button>
        
        <div class="card" style="border-left-color: var(--red);">
            <span style="color:var(--red); font-size:0.7rem;">CONTROL DE ERRORES</span>
            <button class="btn" onclick="leerDTCs()">üîç LEER FALLAS (REAL)</button>
            <button class="btn" style="background:var(--red); color:white; margin-top:10px;" onclick="borrarDTCs()">üî• BORRAR CHECK ENGINE (04)</button>
            <div id="dtcResult" style="margin-top:10px; font-size:0.8rem; color:var(--gold);"></div>
        </div>

        <div class="card">
            <span style="color:var(--blue); font-size:0.7rem;">FLUJO DE DATOS SENSORIZADOS</span>
            <div class="live-data">
                <div class="data-box"><span class="lbl">RPM</span><span class="val" id="valRPM">---</span></div>
                <div class="data-box"><span class="lbl">TEMP</span><span class="val" id="valTemp">---</span></div>
            </div>
            <button class="btn" id="btnLive" style="background:#222; color:var(--blue); border:1px solid var(--blue);" onclick="toggleLectura()">üì° INICIAR LECTURA REAL</button>
        </div>
    </div>

    <nav class="nav">
        <div class="nav-item active" onclick="tab('diag', this)">ESCANER</div>
        <div class="nav-item" onclick="tab('magic', this)">CAJA M√ÅGICA</div>
        <div class="nav-item" onclick="puente('SOPORTE')">SOPORTE</div>
    </nav>

    <script>
        let obdCharacteristic;
        let isReading = false;

        async function conectarOBD() {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'OBD' }, { namePrefix: 'ELM' }],
                    optionalServices: ['00001101-0000-1000-8000-00805f9b34fb']
                });
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService('00001101-0000-1000-8000-00805f9b34fb');
                obdCharacteristic = await service.getCharacteristic('00001101-0000-1000-8000-00805f9b34fb');
                
                document.getElementById('status').innerText = "VINCULADO: " + device.name;
                document.getElementById('status').style.color = "var(--green)";
                alert("‚úÖ Comunicaci√≥n establecida con el chip.");
            } catch (e) { alert("Error: No se encontr√≥ el esc√°ner o el navegador no soporta BT."); }
        }

        async function enviarComando(cmd) {
            if (!obdCharacteristic) return null;
            const encoder = new TextEncoder();
            await obdCharacteristic.writeValue(encoder.encode(cmd + '\r'));
            // Aqu√≠ en un futuro leer√≠amos la respuesta con characteristic.readValue()
            return "OK"; 
        }

        async function leerDTCs() {
            document.getElementById('dtcResult').innerText = "Solicitando c√≥digos (03)...";
            await enviarComando('03');
            alert("Comando 03 enviado. Esperando respuesta de la ECU...");
        }

        async function borrarDTCs() {
            if(confirm("‚ö†Ô∏è ¬øSeguro que quieres borrar los c√≥digos? El motor debe estar en ON y apagado.")) {
                await enviarComando('04');
                alert("üî• Comando 04 (Borrar) enviado. El Check Engine deber√≠a apagarse.");
            }
        }

        function toggleLectura() {
            isReading = !isReading;
            const btn = document.getElementById('btnLive');
            if(isReading) {
                btn.innerText = "üõë DETENER";
                btn.style.background = "var(--red)";
                pedirDatos();
            } else {
                btn.innerText = "üì° INICIAR LECTURA REAL";
                btn.style.background = "#222";
            }
        }

        async function pedirDatos() {
            if(!isReading) return;
            // Comando 010C es para RPM
            await enviarComando('010C');
            // Nota: Aqu√≠ falta la l√≥gica de decodificaci√≥n Hexadecimal a decimal
            // Para fines de esta versi√≥n, quitamos la simulaci√≥n aleatoria.
            document.getElementById('valRPM').innerText = "BUSCANDO...";
            setTimeout(pedirDatos, 2000);
        }

        function tab(id, el) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function puente(accion) { window.location.href = "https://wa.me/527776838196?text=" + encodeURIComponent(accion); }
    </script>
</body>
</html>

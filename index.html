
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PROPART V42.2 | UNLOCK CONNECT</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto+Mono&display=swap" rel="stylesheet">
    <style>
        :root { --blue: #00f3ff; --purple: #bc13fe; --dark: #050505; --green: #0f0; --red: #ff0055; }
        body { background: var(--dark); color: white; font-family: 'Roboto Mono', monospace; margin: 0; text-align: center; }
        .top-bar { background: #000; padding: 20px; border-bottom: 2px solid var(--blue); box-shadow: 0 0 15px var(--blue); }
        .card { background: #111; border: 1px solid #333; padding: 20px; margin: 20px; border-radius: 12px; border-left: 5px solid var(--blue); }
        .btn { background: var(--blue); color: #000; border: none; padding: 18px; width: 100%; font-family: 'Orbitron'; font-weight: bold; border-radius: 8px; cursor: pointer; font-size: 0.8rem; margin-top: 15px; }
        .status-box { font-size: 0.7rem; margin-bottom: 10px; padding: 5px; border-radius: 5px; }
    </style>
</head>
<body>

<div class="top-bar">
    <div style="font-family:'Orbitron'; color:var(--blue);">PROPART V42.2</div>
</div>

<div class="card">
    <div id="status" class="status-box" style="background:#200; color:var(--red);">ESTADO: DESCONECTADO</div>
    
    <button class="btn" onclick="vincularUniversal()" style="background:var(--green);">1. BUSCAR CUALQUIER OBD2</button>
    
    <div id="controles" style="display:none; margin-top:20px;">
        <button class="btn" onclick="enviarComando('010C')">üìä PEDIR RPM (01 0C)</button>
        <button class="btn" onclick="enviarComando('04')" style="background:var(--red); color:white;">üî• BORRAR FALLAS (04)</button>
        <p style="font-size:0.6rem; color:#888; margin-top:10px;">Comandos enviados por canal RFCOMM</p>
    </div>
</div>

<div class="card" style="border-left-color: var(--purple);">
    <button class="btn" style="background:var(--purple); color:white;" onclick="window.location.href='https://wa.me/527776838196'">üí¨ AYUDA DIRECTA (JULSS)</button>
</div>

<script>
    let gattServer;
    let bluetoothCharacteristic;

    async function vincularUniversal() {
        const status = document.getElementById('status');
        try {
            status.innerText = "BUSCANDO DISPOSITIVOS...";
            status.style.background = "#220";
            status.style.color = "yellow";

            // Filtro agresivo: Acepta todo lo que diga OBD, ELM o que no tenga nombre
            const device = await navigator.bluetooth.requestDevice({
                acceptAllDevices: true,
                optionalServices: ['00001101-0000-1000-8000-00805f9b34fb'] // UUID est√°ndar Serial Port
            });

            status.innerText = "CONECTANDO A: " + device.name;
            
            gattServer = await device.gatt.connect();
            const service = await gattServer.getPrimaryService('00001101-0000-1000-8000-00805f9b34fb');
            bluetoothCharacteristic = await service.getCharacteristic('00001101-0000-1000-8000-00805f9b34fb');

            status.innerText = "‚úÖ CONECTADO EXITOSAMENTE";
            status.style.background = "#020";
            status.style.color = "var(--green)";
            document.getElementById('controles').style.display = "block";

        } catch (error) {
            console.log(error);
            status.innerText = "‚ùå ERROR: " + error.message;
            status.style.background = "#200";
            status.style.color = "var(--red)";
            alert("Socio, activa GPS y Bluetooth. Si usas iPhone, ¬°esto solo jala en la app Bluefy!");
        }
    }

    async function enviarComando(cmd) {
        if (!bluetoothCharacteristic) return alert("¬°VINCULA PRIMERO!");
        try {
            const encoder = new TextEncoder();
            await bluetoothCharacteristic.writeValue(encoder.encode(cmd + '\r'));
            alert("Comando " + cmd + " enviado. Mira el esc√°ner, debe parpadear.");
        } catch (e) {
            alert("Error al enviar: " + e.message);
        }
    }
</script>
</body>
</html>
